<?xml version="1.0" encoding="UTF-8"?>
<project name="terrastore-install" basedir=".">

    <target name="server" if="INSTALL_DIR" description="Install Terrastore server.">

        <unzip src="terrastore-master/terrastore-master.zip" dest="${java.io.tmpdir}/terrastore-install"/>

        <copy todir="${INSTALL_DIR}">
            <fileset dir="terrastore-server/"/>
        </copy>

        <copy todir="${INSTALL_DIR}/terrastore-master-libs">
            <fileset dir="${java.io.tmpdir}/terrastore-install/terrastore-master/">
                <include name="*.txt"/>
                <include name="bin/**"/>
                <include name="lib/**"/>
                <include name="modules/**"/>
            </fileset>
        </copy>

        <chmod dir="${INSTALL_DIR}/bin" perm="ugo+x" includes="**/*.sh"/>

        <chmod dir="${INSTALL_DIR}/terrastore-master-libs/bin" perm="ugo+x" includes="**/*.sh"/>

    </target>

    <target name="single-master" if="INSTALL_DIR" description="Install single Terrastore master">

        <antcall target="common-master">
            <param name="config" value="terracotta-config.xml"/>
            <param name="master" value="terrastore-single-master"/>
        </antcall>

    </target>

    <target name="ha-master-1" if="INSTALL_DIR" description="Install Terrastore ha master 1.">

        <antcall target="common-master">
            <param name="config" value="terracotta-config-ha.xml"/>
            <param name="master" value="terrastore-ha-master-1"/>
        </antcall>

    </target>

    <target name="ha-master-2" if="INSTALL_DIR" description="Install Terrastore ha master 2.">

        <antcall target="common-master">
            <param name="config" value="terracotta-config-ha.xml"/>
            <param name="master" value="terrastore-ha-master-2"/>
        </antcall>

    </target>

    <target name="common-master">

        <unzip src="terrastore-master/terrastore-master.zip" dest="${java.io.tmpdir}/terrastore-install"/>

        <replace file="${java.io.tmpdir}/terrastore-install/terrastore-master/bin/start.sh">
            <replacefilter
                token="@master.config@"
                value="${config}"/>
            <replacefilter
                token="@master.name@"
                value="${master}"/>
        </replace>

        <copy file="terrastore-master/${config}" todir="${INSTALL_DIR}"/>

        <copy todir="${INSTALL_DIR}">
            <fileset dir="${java.io.tmpdir}/terrastore-install/terrastore-master/"/>
        </copy>

        <chmod dir="${INSTALL_DIR}/bin" perm="ugo+x" includes="**/*.sh"/>

    </target>

</project>
